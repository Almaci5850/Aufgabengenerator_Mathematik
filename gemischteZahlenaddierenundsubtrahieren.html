<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trainer: Gemischte Zahlen</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
        }

        .container {
            background-color: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 550px;
            width: 90%;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 1rem;
        }

        /* Difficulty Selector Styling */
        .difficulty-container {
            background-color: #ecf0f1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: inline-block;
        }
        
        .radio-label {
            margin: 0 10px;
            cursor: pointer;
            font-size: 0.95rem;
            color: #2c3e50;
        }

        .task-display {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 2rem;
            color: #34495e;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        /* Fraction styling */
        .fraction {
            display: inline-block;
            text-align: center;
            vertical-align: middle;
            margin: 0 5px;
            font-size: 0.8em;
        }
        .top {
            border-bottom: 2px solid #34495e;
            display: block;
            padding: 0 5px;
        }
        .bottom {
            display: block;
            padding: 0 5px;
        }
        .whole {
            font-size: 1.2em;
            margin-right: 2px;
        }

        .input-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 1.5rem;
        }

        input {
            width: 60px;
            padding: 10px;
            font-size: 1.2rem;
            text-align: center;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            transition: border-color 0.3s;
        }

        input:focus {
            outline: none;
            border-color: #3498db;
        }

        .fraction-input {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background-color: #2980b9;
        }

        .btn-new {
            background-color: #95a5a6;
        }
        .btn-new:hover {
            background-color: #7f8c8d;
        }

        #feedback {
            margin-top: 1.5rem;
            font-size: 1.1rem;
            font-weight: bold;
            min-height: 1.5em;
        }

        .correct { color: #27ae60; }
        .wrong { color: #c0392b; }
        .hint { font-size: 0.9rem; color: #7f8c8d; margin-top: 5px; font-weight: normal; }
    </style>
</head>
<body>

<div class="container">
    <h2>Gemischte Zahlen</h2>
    
    <div class="difficulty-container">
        <strong>Schwierigkeit:</strong><br>
        <label class="radio-label">
            <input type="radio" name="difficulty" value="1" checked onchange="generateTask()"> Stufe 1 (Leicht)
        </label>
        <label class="radio-label">
            <input type="radio" name="difficulty" value="2" onchange="generateTask()"> Stufe 2 (Schwer)
        </label>
    </div>

    <div class="task-display" id="taskArea">
        </div>

    <div class="input-group">
        <div style="text-align:center">
            <label style="display:block; font-size:0.8rem; color:#7f8c8d">Ganzes</label>
            <input type="number" id="inputWhole" placeholder="0">
        </div>
        <div class="fraction-input">
            <input type="number" id="inputNum" placeholder="Zähler">
            <div style="height: 2px; background-color: #bdc3c7; width: 100%;"></div>
            <input type="number" id="inputDenom" placeholder="Nenner">
        </div>
    </div>

    <button class="btn" onclick="checkAnswer()">Prüfen</button>
    <button class="btn btn-new" onclick="generateTask()">Neue Aufgabe</button>

    <div id="feedback"></div>
</div>

<script>
    let currentTask = {};

    function gcd(a, b) { return b === 0 ? a : gcd(b, a % b); }
    function simplify(n, d) {
        const common = gcd(Math.abs(n), Math.abs(d));
        return [n / common, d / common];
    }
    function rnd(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function getDifficulty() {
        const radios = document.getElementsByName('difficulty');
        for (let r of radios) {
            if (r.checked) return parseInt(r.value);
        }
        return 1;
    }

    function generateTask() {
        // Reset Inputs
        document.getElementById('inputWhole').value = '';
        document.getElementById('inputNum').value = '';
        document.getElementById('inputDenom').value = '';
        document.getElementById('feedback').innerHTML = '';
        document.getElementById('feedback').className = '';

        const level = getDifficulty();
        let validTaskFound = false;

        let num1_obj, num2_obj, op;

        // Schleife, bis wir Zahlen gefunden haben, die zur Schwierigkeitsstufe passen
        while (!validTaskFound) {
            
            const d1 = rnd(2, 12);
            // Häufiger gleicher Nenner für einfachere Aufgaben, sonst zufällig
            const d2 = Math.random() > 0.4 ? d1 : rnd(2, 12);

            // Ganze Zahlen
            let w1 = rnd(1, 8);
            let w2 = rnd(1, 6);

            // Zähler (müssen kleiner als Nenner sein für gemischte Zahlen Definition)
            let n1 = rnd(1, d1 - 1);
            let n2 = rnd(1, d2 - 1);

            op = Math.random() > 0.5 ? '+' : '-';

            const valFraction1 = n1 / d1;
            const valFraction2 = n2 / d2;
            const valTotal1 = w1 + valFraction1;
            const valTotal2 = w2 + valFraction2;

            if (level === 1) {
                if (op === '+') {
                    // STUFE 1 ADDITION: Bruchanteile dürfen zusammen nicht > 1 sein
                    if (valFraction1 + valFraction2 <= 1) {
                        num1_obj = { w: w1, n: n1, d: d1 };
                        num2_obj = { w: w2, n: n2, d: d2 };
                        validTaskFound = true;
                    }
                } else {
                    // STUFE 1 SUBTRAKTION: Kein Borgen
                    // Bedingung 1: Gesamtzahl 1 muss größer sein als 2 (keine negativen Ergebnisse)
                    // Bedingung 2: Bruch 1 muss größer/gleich Bruch 2 sein
                    
                    if (valTotal1 > valTotal2) {
                        // Wenn der Bruch im Minuend kleiner ist als im Subtrahend, müssen wir tauschen oder neu generieren.
                        // Um es einfach zu halten: Wir tauschen einfach die Bruchanteile, wenn w1 > w2, 
                        // oder wir sorgen dafür, dass n1/d1 >= n2/d2 ist.
                        
                        if (valFraction1 >= valFraction2) {
                            num1_obj = { w: w1, n: n1, d: d1 };
                            num2_obj = { w: w2, n: n2, d: d2 };
                            validTaskFound = true;
                        } 
                        // Falls Bruch 1 kleiner ist, aber w1 groß genug -> In Stufe 1 verboten (wäre Borgen)
                        // Also verwerfen wir diese Kombination und die Schleife läuft weiter.
                    }
                }
            } 
            else {
                // STUFE 2: Alles erlaubt (außer negatives Gesamtergebnis)
                if (op === '-') {
                    if (valTotal1 < valTotal2) {
                        // Tauschen, damit Ergebnis positiv bleibt
                        let tempW = w1, tempN = n1, tempD = d1;
                        w1 = w2; n1 = n2; d1 = d2;
                        w2 = tempW; n2 = tempN; d2 = tempD;
                    }
                    // Verhindern von identischen Zahlen (Ergebnis 0 ist langweilig)
                    if (Math.abs(valTotal1 - valTotal2) < 0.001) continue;
                }
                
                num1_obj = { w: w1, n: n1, d: d1 };
                num2_obj = { w: w2, n: n2, d: d2 };
                validTaskFound = true;
            }
        }

        currentTask = {
            n1: num1_obj,
            n2: num2_obj,
            op: op
        };

        calculateSolution();
        renderTask();
    }

    function calculateSolution() {
        const num1 = currentTask.n1.w * currentTask.n1.d + currentTask.n1.n;
        const den1 = currentTask.n1.d;
        
        const num2 = currentTask.n2.w * currentTask.n2.d + currentTask.n2.n;
        const den2 = currentTask.n2.d;

        const commonDenom = (den1 * den2) / gcd(den1, den2); // kgV

        const num1_expanded = num1 * (commonDenom / den1);
        const num2_expanded = num2 * (commonDenom / den2);

        let resNum, resDenom;

        if (currentTask.op === '+') {
            resNum = num1_expanded + num2_expanded;
        } else {
            resNum = num1_expanded - num2_expanded;
        }
        resDenom = commonDenom;

        const simple = simplify(resNum, resDenom);
        resNum = simple[0];
        resDenom = simple[1];

        const resWhole = Math.floor(resNum / resDenom);
        const resRemNum = resNum % resDenom;

        currentTask.solution = {
            w: resWhole,
            n: resRemNum,
            d: resDenom
        };
    }

    function renderTask() {
        const t = currentTask;
        const html1 = `<span class="whole">${t.n1.w}</span><div class="fraction"><span class="top">${t.n1.n}</span><span class="bottom">${t.n1.d}</span></div>`;
        const html2 = `<span class="whole">${t.n2.w}</span><div class="fraction"><span class="top">${t.n2.n}</span><span class="bottom">${t.n2.d}</span></div>`;
        
        document.getElementById('taskArea').innerHTML = `${html1} ${t.op} ${html2} = ?`;
    }

    function checkAnswer() {
        const userW = parseInt(document.getElementById('inputWhole').value) || 0;
        const userN = parseInt(document.getElementById('inputNum').value) || 0;
        const userD = parseInt(document.getElementById('inputDenom').value) || 1;

        const sol = currentTask.solution;
        const userVal = userW + (userN / userD);
        const solVal = sol.w + (sol.n / sol.d);

        const feedbackEl = document.getElementById('feedback');

        if (Math.abs(userVal - solVal) < 0.000001) {
            const isSimplified = (userN === sol.n && userD === sol.d && userW === sol.w);
            
            if(sol.n === 0 && userN === 0 && userW === sol.w) {
                 feedbackEl.innerHTML = "Richtig! Das Ergebnis ist eine ganze Zahl.";
                 feedbackEl.className = "correct";
            } else if (isSimplified) {
                feedbackEl.innerHTML = "Perfekt! Richtig und vollständig gekürzt.";
                feedbackEl.className = "correct";
            } else {
                feedbackEl.innerHTML = `Richtig gerechnet! <br><span class='hint'>Aber du kannst noch kürzen oder umwandeln. Die beste Form ist: ${sol.w > 0 ? sol.w : ''} ${sol.n > 0 ? sol.n + '/' + sol.d : ''}</span>`;
                feedbackEl.className = "correct";
            }
        } else {
            let solString = sol.n === 0 ? `${sol.w}` : `${sol.w > 0 ? sol.w : ''} ${sol.n}/${sol.d}`;
            feedbackEl.innerHTML = `Leider falsch. Die Lösung ist: <b>${solString}</b>`;
            feedbackEl.className = "wrong";
        }
    }

    // Start
    generateTask();
</script>

</body>
</html>